name: ğŸš€ Deploy CÃ³digo (sem alteraÃ§Ãµes de BD)

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'migrations/**'
      - '*.md'
      - '.gitignore'
      - 'docker-compose.dev.yml'
      - 'docker-compose.production-debug.yml'

jobs:
  deploy:
    name: Deploy AplicaÃ§Ã£o
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, iconv, json, mbstring, fileinfo
        
    - name: ğŸ“¦ Cache Composer
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: ğŸ”§ Instalar dependÃªncias
      run: composer install --prefer-dist --no-progress --no-suggest --no-dev --optimize-autoloader
      
    - name: âœ… Validar composer.json
      run: composer validate --strict
      
    - name: ğŸ§ª Executar testes bÃ¡sicos (se existirem)
      run: |
        if [ -f "phpunit.xml" ] || [ -f "phpunit.xml.dist" ]; then
          vendor/bin/phpunit --testsuite=unit --coverage-text --colors=never
        else
          echo "Nenhum teste encontrado, prosseguindo..."
        fi
        
    - name: ğŸš€ Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script_stop: true
        script: |
          echo "ğŸ”„ Iniciando deploy..."
          
          # Navegar para diretÃ³rio do projeto
          cd /root/buscaprecos-main || exit 1
          
          # Backup do cÃ³digo atual (fallback)
          echo "ğŸ“¦ Criando backup do cÃ³digo atual..."
          cp -r . ../backup_code_$(date +%Y%m%d_%H%M%S) || true
          
          # Atualizar cÃ³digo do GitHub
          echo "â¬‡ï¸ Atualizando cÃ³digo do GitHub..."
          git fetch origin
          git reset --hard origin/main
          
          # Instalar/atualizar dependÃªncias
          echo "ğŸ“¦ Instalando dependÃªncias..."
          composer install --no-dev --optimize-autoloader
          
          # Reiniciar serviÃ§os Docker
          echo "ğŸ”„ Reiniciando serviÃ§os..."
          docker service update --force app_app
          docker service update --force webserver_webserver
          
          # Verificar status dos serviÃ§os
          echo "âœ… Verificando status dos serviÃ§os..."
          sleep 10
          docker service ls | grep -E "(app_app|webserver_webserver)"
          
          echo "ğŸ‰ Deploy concluÃ­do com sucesso!"
          
    - name: ğŸ”” Notificar sucesso
      if: success()
      run: |
        echo "âœ… Deploy realizado com sucesso!"
        echo "ğŸŒ AplicaÃ§Ã£o disponÃ­vel em produÃ§Ã£o"
        
    - name: ğŸš¨ Notificar falha
      if: failure()
      run: |
        echo "âŒ Deploy falhou!"
        echo "ğŸ“‹ Verifique os logs para mais detalhes"