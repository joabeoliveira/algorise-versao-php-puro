name: ğŸ—ƒï¸ Deploy com MigraÃ§Ã£o de Banco de Dados

on:
  push:
    branches: [ main, master ]
    paths:
      - 'migrations/**'
  workflow_dispatch:
    inputs:
      force_migration:
        description: 'ForÃ§ar execuÃ§Ã£o de migrations'
        required: false
        default: false
        type: boolean

jobs:
  validate-migrations:
    name: Validar Migrations
    runs-on: ubuntu-latest
    outputs:
      has_migrations: ${{ steps.check.outputs.has_migrations }}
      migration_files: ${{ steps.check.outputs.migration_files }}
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
        
    - name: ğŸ” Verificar mudanÃ§as em migrations
      id: check
      run: |
        if [ -d "migrations" ] && [ "$(ls -A migrations)" ]; then
          echo "has_migrations=true" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Migrations encontradas:"
          ls -la migrations/
          echo "migration_files=$(ls migrations/ | tr '\n' ',')" >> $GITHUB_OUTPUT
        else
          echo "has_migrations=false" >> $GITHUB_OUTPUT
          echo "âŒ Nenhuma migration encontrada"
        fi

  backup-production:
    name: Backup da ProduÃ§Ã£o
    runs-on: ubuntu-latest
    needs: validate-migrations
    if: needs.validate-migrations.outputs.has_migrations == 'true' || github.event.inputs.force_migration == 'true'
    
    steps:
    - name: ğŸ—ƒï¸ Backup do Banco de Dados
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          echo "ğŸ—ƒï¸ Iniciando backup da produÃ§Ã£o..."
          
          # Criar diretÃ³rio de backups se nÃ£o existir
          mkdir -p /root/backups
          
          # Nome do arquivo de backup
          BACKUP_FILE="/root/backups/backup_pre_migration_$(date +%Y%m%d_%H%M%S).sql"
          
          # Realizar backup
          docker exec db_db mysqldump -u root -p${{ secrets.DB_ROOT_PASSWORD }} ${{ secrets.DB_NAME }} > "$BACKUP_FILE"
          
          # Verificar se backup foi criado
          if [ -f "$BACKUP_FILE" ]; then
            echo "âœ… Backup criado com sucesso: $BACKUP_FILE"
            echo "ğŸ“Š Tamanho do backup: $(du -h $BACKUP_FILE | cut -f1)"
            
            # Manter apenas os Ãºltimos 10 backups
            cd /root/backups
            ls -t backup_pre_migration_*.sql | tail -n +11 | xargs rm -f || true
            
            echo "BACKUP_FILE=$BACKUP_FILE" >> $GITHUB_ENV
          else
            echo "âŒ Falha ao criar backup!"
            exit 1
          fi

  deploy-with-migration:
    name: Deploy com Migration
    runs-on: ubuntu-latest
    needs: [validate-migrations, backup-production]
    if: needs.validate-migrations.outputs.has_migrations == 'true' || github.event.inputs.force_migration == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, iconv, json, mbstring, fileinfo
        
    - name: ğŸ“¦ Instalar dependÃªncias
      run: composer install --prefer-dist --no-progress --no-suggest --no-dev --optimize-autoloader
      
    - name: ğŸ—ƒï¸ Aplicar Migrations e Deploy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script_stop: true
        script: |
          echo "ğŸš€ Iniciando deploy com migration..."
          
          # Navegar para diretÃ³rio do projeto
          cd /root/buscaprecos-main || exit 1
          
          # Backup do cÃ³digo atual
          echo "ğŸ“¦ Backup do cÃ³digo atual..."
          cp -r . ../backup_code_$(date +%Y%m%d_%H%M%S) || true
          
          # Atualizar cÃ³digo
          echo "â¬‡ï¸ Atualizando cÃ³digo..."
          git fetch origin
          git reset --hard origin/main
          
          # Aplicar migrations
          echo "ğŸ—ƒï¸ Aplicando migrations..."
          if [ -d "migrations" ] && [ "$(ls -A migrations)" ]; then
            for migration in migrations/*.sql; do
              if [ -f "$migration" ]; then
                echo "ğŸ“ Aplicando: $migration"
                docker exec -i db_db mysql -u root -p${{ secrets.DB_ROOT_PASSWORD }} ${{ secrets.DB_NAME }} < "$migration"
                
                if [ $? -eq 0 ]; then
                  echo "âœ… Migration aplicada: $migration"
                else
                  echo "âŒ Falha ao aplicar migration: $migration"
                  echo "ğŸ”„ Iniciando rollback..."
                  
                  # Restaurar backup em caso de falha
                  LATEST_BACKUP=$(ls -t /root/backups/backup_pre_migration_*.sql | head -1)
                  if [ -f "$LATEST_BACKUP" ]; then
                    echo "ğŸ“ Restaurando backup: $LATEST_BACKUP"
                    docker exec -i db_db mysql -u root -p${{ secrets.DB_ROOT_PASSWORD }} ${{ secrets.DB_NAME }} < "$LATEST_BACKUP"
                    echo "ğŸ”„ Rollback do banco concluÃ­do"
                  fi
                  
                  exit 1
                fi
              fi
            done
          else
            echo "â„¹ï¸ Nenhuma migration para aplicar"
          fi
          
          # Instalar dependÃªncias
          echo "ğŸ“¦ Instalando dependÃªncias..."
          composer install --no-dev --optimize-autoloader
          
          # Reiniciar serviÃ§os
          echo "ğŸ”„ Reiniciando serviÃ§os..."
          docker service update --force app_app
          docker service update --force webserver_webserver
          
          # Aguardar e verificar serviÃ§os
          echo "â³ Aguardando inicializaÃ§Ã£o dos serviÃ§os..."
          sleep 15
          
          # Verificar status
          echo "âœ… Verificando status dos serviÃ§os..."
          docker service ls | grep -E "(app_app|webserver_webserver)"
          
          # Teste bÃ¡sico de conectividade
          echo "ğŸ”— Testando conectividade..."
          if docker exec app_app php -r "echo 'PHP OK\n';"; then
            echo "âœ… AplicaÃ§Ã£o PHP respondendo"
          else
            echo "âŒ Problema com aplicaÃ§Ã£o PHP"
            exit 1
          fi
          
          echo "ğŸ‰ Deploy com migration concluÃ­do com sucesso!"
          
    - name: âœ… ValidaÃ§Ã£o pÃ³s-deploy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          echo "ğŸ” Iniciando validaÃ§Ã£o pÃ³s-deploy..."
          
          # Verificar se serviÃ§os estÃ£o rodando
          SERVICES_OK=true
          
          if ! docker service ls | grep -q "app_app.*1/1"; then
            echo "âŒ ServiÃ§o app_app nÃ£o estÃ¡ rodando corretamente"
            SERVICES_OK=false
          fi
          
          if ! docker service ls | grep -q "webserver_webserver.*1/1"; then
            echo "âŒ ServiÃ§o webserver_webserver nÃ£o estÃ¡ rodando corretamente"
            SERVICES_OK=false
          fi
          
          # Verificar conectividade com banco
          if docker exec db_db mysql -u root -p${{ secrets.DB_ROOT_PASSWORD }} -e "SELECT 1" ${{ secrets.DB_NAME }} > /dev/null 2>&1; then
            echo "âœ… Conectividade com banco OK"
          else
            echo "âŒ Problema de conectividade com banco"
            SERVICES_OK=false
          fi
          
          if [ "$SERVICES_OK" = false ]; then
            echo "ğŸš¨ Falha na validaÃ§Ã£o pÃ³s-deploy!"
            echo "ğŸ“‹ Logs dos serviÃ§os:"
            docker service logs app_app --tail 20
            docker service logs webserver_webserver --tail 20
            exit 1
          else
            echo "ğŸ‰ ValidaÃ§Ã£o pÃ³s-deploy bem-sucedida!"
          fi
          
    - name: ğŸ”” Notificar sucesso
      if: success()
      run: |
        echo "âœ… Deploy com migration realizado com sucesso!"
        echo "ğŸ—ƒï¸ Migrations aplicadas: ${{ needs.validate-migrations.outputs.migration_files }}"
        echo "ğŸŒ AplicaÃ§Ã£o disponÃ­vel em produÃ§Ã£o"
        
    - name: ğŸš¨ Notificar falha
      if: failure()
      run: |
        echo "âŒ Deploy com migration falhou!"
        echo "ğŸ”„ Backup foi restaurado automaticamente"
        echo "ğŸ“‹ Verifique os logs para mais detalhes"